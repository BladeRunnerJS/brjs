
apply from: 'composite-tasks.gradle'
apply from: 'wrapper.gradle'

allprojects {
	def projectContainingSharedLogic = (project.parent) ? project.parent : project
	apply from: projectContainingSharedLogic.file('buildConfig.gradle')
	apply from: projectContainingSharedLogic.file('dependencies.gradle')
	
	apply plugin: 'eclipse'
	apply plugin: 'idea'
	apply plugin: 'base'
	
	repositories {
		mavenCentral()
		maven { url "http://bladerunnerjs.github.io/brjs-build-dependencies/repo" }
	}
	
	buildscript {
    	repositories {
    		mavenCentral()
    	}
	}
		
	tasks.withType(Copy) {
		fileMode = 0755
		includeEmptyDirs = false
	}
	tasks.withType(Sync) {
		fileMode = 0755
		includeEmptyDirs = false
	}
	tasks.withType(Zip) {
		fileMode = 0755
		includeEmptyDirs = false
	}
	
}

subprojects { p ->
	version = new org.bladerunnerjs.BuildVersionCalculator(p).calculateVersion()
	group = 'org.bladerunnerjs'
		
	afterEvaluate { project ->
		
		if (project.plugins.hasPlugin(JavaPlugin)) {
			sourceCompatibility = '1.7'
			targetCompatibility = '1.7'
					
			project.tasks.withType(Test) { testTask ->
				test {
					testLogging {
						events 'skipped', 'failed'
						exceptionFormat 'full'
						info {
							displayGranularity = 0
						}
					}
				}
			}
			
			project.tasks.withType(JavaCompile) {
				options.compilerArgs += ['-Xlint:all']
				options.encoding = 'UTF-8'
			}
		}
	
	}
	
}

configurations {
	browsers_dep
	browsers_webdriver
}

dependencies {
	browsers_dep dependency('chrome-stable')
	browsers_dep dependency('firefox-stable') 
	
	browsers_webdriver dependency('firefox-webdriver') 
}


def browserRootDir = buildDir.path+"/browsers"
def browserProfileDir = "${browserRootDir}/profile"
task copyBrowsers(type: Sync) {
	description "Copies all browser dependencies into " + relativePath(browserRootDir) + "."
	from { configurations.browsers_dep.collect { browser -> zipTree(browser) } }
	from { configurations.browsers_webdriver.collect { browser -> zipTree(browser) } }
	into browserRootDir
	doLast {
		//TODO: this should probabaly be done in a task listener
		if (file(browserProfileDir).exists()) {
			delete browserProfileDir
		}
    	file(browserProfileDir).mkdirs();
    	file(browserProfileDir + "/chrome").mkdir();
    		/* prevent chrome asking to set default search engine */
    		file(browserProfileDir + "/chrome/First Run").createNewFile();
    	file(browserProfileDir + "/chromium").mkdir();
    		/* prevent chromium asking to set default search engine */
    		file(browserProfileDir + "/chromium/First Run").createNewFile();
    	file(browserProfileDir + "/firefox").mkdir();
    		file(browserProfileDir + "/firefox/prefs.js").createNewFile();
    		file(browserProfileDir + "/firefox/prefs.js").text = "user_pref(\"browser.shell.checkDefaultBrowser\", false);\nuser_pref(\"browser.sessionstore.max_resumed_crashes\", -1);\nuser_pref(\"toolkit.startup.max_resumed_crashes\", -1);\nuser_pref(\"toolkit.startup.recent_crashes\", -1);\n";
    	}
}
